<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Mario Kart Team Tournament</title>

<style>
body{font-family:sans-serif;background:#111;color:white;}
table{border-collapse:collapse;}
td,th{border:1px solid #555;padding:4px;text-align:center;}

input{
  width:50px;
  background:#222;
  color:white;
  border:1px solid #555;
  text-align:center;
}

.teamInput{width:120px;margin:3px;}
.shortcutInput{width:40px;}

.obs{
  background:black;
  padding:10px;
  margin-top:20px;
  width:360px;
  font-size:20px;
}
</style>
</head>

<body>

<h1>MK Team Tournament Tool</h1>

å½¢å¼ï¼š
<select id="formatSelect">
<option value="12">12v12</option>
<option value="8">8v8</option>
<option value="6">6v6</option>
<option value="4">4v4</option>
<option value="3">3v3</option>
<option value="2">2v2</option>
</select>

ãƒ¬ãƒ¼ã‚¹æ•°ï¼š
<select id="raceSelect"></select>

è‡ªãƒãƒ¼ãƒ åï¼š
<input id="myTeamInput">

<button onclick="init()">ç”Ÿæˆ</button>

<h2 id="remainRace">æ®‹ã‚Šãƒ¬ãƒ¼ã‚¹: -</h2>
<h2 id="comebackLine">é€†è»¢å¯èƒ½ãƒ©ã‚¤ãƒ³: -</h2>
<h2 id="championStatus">å„ªå‹åˆ¤å®š: -</h2>

<hr>

<div id="teamNameArea"></div>
<br>
<div id="tableArea"></div>

<h2>ã‚³ãƒ”ãƒ¼ç”¨</h2>
<textarea id="copyArea" rows="10" cols="40"></textarea>
<br>
<button onclick="copyScores()">ã‚³ãƒ”ãƒ¼</button>

<h2>OBSâ‘ </h2>
<div id="obs1" class="obs"></div>

<h2>OBSâ‘¢</h2>
<div id="obs3" class="obs"></div>

<script>

/* ===============================
   é…ç‚¹
================================ */
const POINT_TABLE=[
15,12,10,9,9,8,8,7,7,6,6,6,
5,5,5,4,4,4,3,3,3,2,2,1
];

let teams=[];
let raceCount=12;
let previousRanks={};
let shortcutMap={}; // â†ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆä¿å­˜

/* ãƒ¬ãƒ¼ã‚¹æ•° */
for(let i=8;i<=32;i++){
  raceSelect.append(new Option(i,i));
}

/* åˆæœŸåŒ– */
function init(){

  const teamSize=Number(formatSelect.value);
  raceCount=Number(raceSelect.value);
  const teamCount=24/teamSize;

  teams=[];
  previousRanks={};
  shortcutMap={};

  const area=document.getElementById("teamNameArea");
  area.innerHTML="<h3>ãƒãƒ¼ãƒ è¨­å®š</h3>";

  for(let i=0;i<teamCount;i++){
    teams.push({name:`Team${i+1}`,score:0});

    area.innerHTML+=`
      ãƒãƒ¼ãƒ ${i+1}
      åå‰:<input class="teamInput" id="teamName${i}" value="Team${i+1}">
      SC:<input class="shortcutInput" id="shortcut${i}" maxlength="1">
      <br>`;
  }

  buildTable();
  recalcScores();
}

/* è¡¨ç”Ÿæˆ */
function buildTable(){

  const area=document.getElementById("tableArea");
  area.innerHTML="";
  const table=document.createElement("table");

  let head="<tr><th>é †ä½</th>";
  for(let r=1;r<=raceCount;r++) head+=`<th>R${r}</th>`;
  head+="</tr>";

  table.innerHTML=head;

  for(let rank=1;rank<=24;rank++){

    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${rank}</td>`;

    for(let r=0;r<raceCount;r++){

      const td=document.createElement("td");
      const input=document.createElement("input");

      input.dataset.rank=rank;
      input.dataset.race=r;

      /* ===== ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå…¥åŠ› ===== */
      input.addEventListener("keydown",(e)=>{

        const key=e.key.toLowerCase();

        if(shortcutMap[key]!==undefined){
          e.preventDefault();
          input.value=shortcutMap[key]+1;
          moveNext(input);
          recalcScores();
          return;
        }

        if(e.key==="Enter"){
          e.preventDefault();
          moveNext(input);
        }
      });

      input.addEventListener("input",()=>{
        recalcScores();
      });

      td.appendChild(input);
      tr.appendChild(td);
    }

    table.appendChild(tr);
  }

  area.appendChild(table);
}

/* æ¬¡ã‚»ãƒ«ç§»å‹• */
function moveNext(input){

  const race=Number(input.dataset.race);
  const rank=Number(input.dataset.rank);

  let next=document.querySelector(
    `input[data-race="${race}"][data-rank="${rank+1}"]`
  );

  if(!next){
    next=document.querySelector(
      `input[data-race="${race+1}"][data-rank="1"]`
    );
  }

  if(next) next.focus();
}

/* æ®‹ã‚Šãƒ¬ãƒ¼ã‚¹ */
function getRemainingRaces(){

  let finished=0;

  for(let r=0;r<raceCount;r++){
    const col=[...document.querySelectorAll(`input[data-race="${r}"]`)];
    if(col.every(i=>i.value!=="")) finished++;
  }

  return raceCount-finished;
}

/* æœ€å¤§é€†è»¢å·® */
function calcComebackPerRace(){

  const teamSize=Number(formatSelect.value);

  let max=0;
  let min=0;

  for(let i=0;i<teamSize;i++){
    max+=POINT_TABLE[i];
    min+=POINT_TABLE[POINT_TABLE.length-1-i];
  }

  return max-min;
}

/* ç‚¹æ•°è¨ˆç®— */
function recalcScores(){

  teams.forEach(t=>t.score=0);
  shortcutMap={};

  teams.forEach((t,i)=>{
    t.name=document.getElementById(`teamName${i}`).value;

    const sc=document.getElementById(`shortcut${i}`).value
      .toLowerCase();

    if(sc) shortcutMap[sc]=i;
  });

  document.querySelectorAll("input[data-rank]").forEach(input=>{

    const teamIndex=Number(input.value)-1;
    const rank=Number(input.dataset.rank);

    if(teamIndex>=0 && teamIndex<teams.length){
      teams[teamIndex].score+=POINT_TABLE[rank-1];
    }
  });

  const remain=getRemainingRaces();
  document.getElementById("remainRace").textContent=
    `æ®‹ã‚Šãƒ¬ãƒ¼ã‚¹: ${remain}`;

  updateDisplays(remain);
}

/* è¡¨ç¤ºæ›´æ–° */
function updateDisplays(remain){

  const myTeam=document.getElementById("myTeamInput").value;
  const sorted=[...teams].sort((a,b)=>b.score-a.score);

  const comebackPerRace=calcComebackPerRace();
  const maxSwing=comebackPerRace*remain;

  document.getElementById("comebackLine").textContent=
    `é€†è»¢å¯èƒ½ãƒ©ã‚¤ãƒ³: ${maxSwing}ptsä»¥å†…`;

  let championText="æœªç¢ºå®š";
  if(sorted.length>=2){
    const diff=sorted[0].score-sorted[1].score;
    if(diff>maxSwing){
      championText=`ğŸ† ${sorted[0].name} å„ªå‹ç¢ºå®š`;
    }
  }

  document.getElementById("championStatus").textContent=
    `å„ªå‹åˆ¤å®š: ${championText}`;

  obs1.innerHTML="";
  obs3.innerHTML="";

  let copyText=
`é€†è»¢å¯èƒ½ãƒ©ã‚¤ãƒ³: ${maxSwing}ptsä»¥å†…
${championText}

`;

  let newRanks={};

  sorted.forEach((team,i)=>{
    newRanks[team.name]=i;
  });

  sorted.forEach((team,i)=>{

    const leaderScore=sorted[0].score;
    const diff=leaderScore-team.score;

    const div=document.createElement("div");

    let color="white";
    if(i===0) color="gold";
    else if(i===1) color="silver";
    else if(i===2) color="#cd7f32";

    if(team.name===myTeam) color="red";

    div.style.color=color;

    let arrow="ãƒ»";

    if(previousRanks[team.name]!==undefined){
      const prev=previousRanks[team.name];
      if(prev>i) arrow="â†‘";
      else if(prev<i) arrow="â†“";
      else arrow="â†’";
    }

    let diffText=i===0?"":` (-${diff})`;

    div.textContent=
      `${arrow} ${i+1}. ${team.name} ${team.score}pts${diffText}`;

    obs1.appendChild(div);
    obs3.appendChild(div.cloneNode(true));

    copyText+=div.textContent+"\n";
  });

  previousRanks=newRanks;
  copyArea.value=copyText;
}

/* ã‚³ãƒ”ãƒ¼ */
function copyScores(){
  copyArea.select();
  document.execCommand("copy");
}

</script>
</body>
</html><!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Mario Kart Team Tournament</title>

<style>
body{font-family:sans-serif;background:#111;color:white;}
table{border-collapse:collapse;}
td,th{border:1px solid #555;padding:4px;text-align:center;}

input{
  width:50px;
  background:#222;
  color:white;
  border:1px solid #555;
  text-align:center;
}

.teamInput{width:120px;margin:3px;}
.shortcutInput{width:40px;}

.obs{
  background:black;
  padding:10px;
  margin-top:20px;
  width:360px;
  font-size:20px;
}
</style>
</head>

<body>

<h1>MK Team Tournament Tool</h1>

å½¢å¼ï¼š
<select id="formatSelect">
<option value="12">12v12</option>
<option value="8">8v8</option>
<option value="6">6v6</option>
<option value="4">4v4</option>
<option value="3">3v3</option>
<option value="2">2v2</option>
</select>

ãƒ¬ãƒ¼ã‚¹æ•°ï¼š
<select id="raceSelect"></select>

è‡ªãƒãƒ¼ãƒ åï¼š
<input id="myTeamInput">

<button onclick="init()">ç”Ÿæˆ</button>

<h2 id="remainRace">æ®‹ã‚Šãƒ¬ãƒ¼ã‚¹: -</h2>
<h2 id="comebackLine">é€†è»¢å¯èƒ½ãƒ©ã‚¤ãƒ³: -</h2>
<h2 id="championStatus">å„ªå‹åˆ¤å®š: -</h2>

<hr>

<div id="teamNameArea"></div>
<br>
<div id="tableArea"></div>

<h2>ã‚³ãƒ”ãƒ¼ç”¨</h2>
<textarea id="copyArea" rows="10" cols="40"></textarea>
<br>
<button onclick="copyScores()">ã‚³ãƒ”ãƒ¼</button>

<h2>OBSâ‘ </h2>
<div id="obs1" class="obs"></div>

<h2>OBSâ‘¢</h2>
<div id="obs3" class="obs"></div>

<script>

/* ===============================
   é…ç‚¹
================================ */
const POINT_TABLE=[
15,12,10,9,9,8,8,7,7,6,6,6,
5,5,5,4,4,4,3,3,3,2,2,1
];

let teams=[];
let raceCount=12;
let previousRanks={};
let shortcutMap={}; // â†ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆä¿å­˜

/* ãƒ¬ãƒ¼ã‚¹æ•° */
for(let i=8;i<=32;i++){
  raceSelect.append(new Option(i,i));
}

/* åˆæœŸåŒ– */
function init(){

  const teamSize=Number(formatSelect.value);
  raceCount=Number(raceSelect.value);
  const teamCount=24/teamSize;

  teams=[];
  previousRanks={};
  shortcutMap={};

  const area=document.getElementById("teamNameArea");
  area.innerHTML="<h3>ãƒãƒ¼ãƒ è¨­å®š</h3>";

  for(let i=0;i<teamCount;i++){
    teams.push({name:`Team${i+1}`,score:0});

    area.innerHTML+=`
      ãƒãƒ¼ãƒ ${i+1}
      åå‰:<input class="teamInput" id="teamName${i}" value="Team${i+1}">
      SC:<input class="shortcutInput" id="shortcut${i}" maxlength="1">
      <br>`;
  }

  buildTable();
  recalcScores();
}

/* è¡¨ç”Ÿæˆ */
function buildTable(){

  const area=document.getElementById("tableArea");
  area.innerHTML="";
  const table=document.createElement("table");

  let head="<tr><th>é †ä½</th>";
  for(let r=1;r<=raceCount;r++) head+=`<th>R${r}</th>`;
  head+="</tr>";

  table.innerHTML=head;

  for(let rank=1;rank<=24;rank++){

    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${rank}</td>`;

    for(let r=0;r<raceCount;r++){

      const td=document.createElement("td");
      const input=document.createElement("input");

      input.dataset.rank=rank;
      input.dataset.race=r;

      /* ===== ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå…¥åŠ› ===== */
      input.addEventListener("keydown",(e)=>{

        const key=e.key.toLowerCase();

        if(shortcutMap[key]!==undefined){
          e.preventDefault();
          input.value=shortcutMap[key]+1;
          moveNext(input);
          recalcScores();
          return;
        }

        if(e.key==="Enter"){
          e.preventDefault();
          moveNext(input);
        }
      });

      input.addEventListener("input",()=>{
        recalcScores();
      });

      td.appendChild(input);
      tr.appendChild(td);
    }

    table.appendChild(tr);
  }

  area.appendChild(table);
}

/* æ¬¡ã‚»ãƒ«ç§»å‹• */
function moveNext(input){

  const race=Number(input.dataset.race);
  const rank=Number(input.dataset.rank);

  let next=document.querySelector(
    `input[data-race="${race}"][data-rank="${rank+1}"]`
  );

  if(!next){
    next=document.querySelector(
      `input[data-race="${race+1}"][data-rank="1"]`
    );
  }

  if(next) next.focus();
}

/* æ®‹ã‚Šãƒ¬ãƒ¼ã‚¹ */
function getRemainingRaces(){

  let finished=0;

  for(let r=0;r<raceCount;r++){
    const col=[...document.querySelectorAll(`input[data-race="${r}"]`)];
    if(col.every(i=>i.value!=="")) finished++;
  }

  return raceCount-finished;
}

/* æœ€å¤§é€†è»¢å·® */
function calcComebackPerRace(){

  const teamSize=Number(formatSelect.value);

  let max=0;
  let min=0;

  for(let i=0;i<teamSize;i++){
    max+=POINT_TABLE[i];
    min+=POINT_TABLE[POINT_TABLE.length-1-i];
  }

  return max-min;
}

/* ç‚¹æ•°è¨ˆç®— */
function recalcScores(){

  teams.forEach(t=>t.score=0);
  shortcutMap={};

  teams.forEach((t,i)=>{
    t.name=document.getElementById(`teamName${i}`).value;

    const sc=document.getElementById(`shortcut${i}`).value
      .toLowerCase();

    if(sc) shortcutMap[sc]=i;
  });

  document.querySelectorAll("input[data-rank]").forEach(input=>{

    const teamIndex=Number(input.value)-1;
    const rank=Number(input.dataset.rank);

    if(teamIndex>=0 && teamIndex<teams.length){
      teams[teamIndex].score+=POINT_TABLE[rank-1];
    }
  });

  const remain=getRemainingRaces();
  document.getElementById("remainRace").textContent=
    `æ®‹ã‚Šãƒ¬ãƒ¼ã‚¹: ${remain}`;

  updateDisplays(remain);
}

/* è¡¨ç¤ºæ›´æ–° */
function updateDisplays(remain){

  const myTeam=document.getElementById("myTeamInput").value;
  const sorted=[...teams].sort((a,b)=>b.score-a.score);

  const comebackPerRace=calcComebackPerRace();
  const maxSwing=comebackPerRace*remain;

  document.getElementById("comebackLine").textContent=
    `é€†è»¢å¯èƒ½ãƒ©ã‚¤ãƒ³: ${maxSwing}ptsä»¥å†…`;

  let championText="æœªç¢ºå®š";
  if(sorted.length>=2){
    const diff=sorted[0].score-sorted[1].score;
    if(diff>maxSwing){
      championText=`ğŸ† ${sorted[0].name} å„ªå‹ç¢ºå®š`;
    }
  }

  document.getElementById("championStatus").textContent=
    `å„ªå‹åˆ¤å®š: ${championText}`;

  obs1.innerHTML="";
  obs3.innerHTML="";

  let copyText=
`é€†è»¢å¯èƒ½ãƒ©ã‚¤ãƒ³: ${maxSwing}ptsä»¥å†…
${championText}

`;

  let newRanks={};

  sorted.forEach((team,i)=>{
    newRanks[team.name]=i;
  });

  sorted.forEach((team,i)=>{

    const leaderScore=sorted[0].score;
    const diff=leaderScore-team.score;

    const div=document.createElement("div");

    let color="white";
    if(i===0) color="gold";
    else if(i===1) color="silver";
    else if(i===2) color="#cd7f32";

    if(team.name===myTeam) color="red";

    div.style.color=color;

    let arrow="ãƒ»";

    if(previousRanks[team.name]!==undefined){
      const prev=previousRanks[team.name];
      if(prev>i) arrow="â†‘";
      else if(prev<i) arrow="â†“";
      else arrow="â†’";
    }

    let diffText=i===0?"":` (-${diff})`;

    div.textContent=
      `${arrow} ${i+1}. ${team.name} ${team.score}pts${diffText}`;

    obs1.appendChild(div);
    obs3.appendChild(div.cloneNode(true));

    copyText+=div.textContent+"\n";
  });

  previousRanks=newRanks;
  copyArea.value=copyText;
}

/* ã‚³ãƒ”ãƒ¼ */
function copyScores(){
  copyArea.select();
  document.execCommand("copy");
}

</script>
</body>
</html>
